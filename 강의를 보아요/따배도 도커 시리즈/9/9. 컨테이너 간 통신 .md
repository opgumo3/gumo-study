# 컨테이너 통신
<img src="images/image.png" width="250">

- docker0 는 스트 네트워크와 컨테이너 네트워크를 연결하는 브릿지.
- iptables 를 이용하여 내부적으로 NAT 서비스와 포트 포워딩 기능을 지원
- L2 통신 기반
- container 생성 시 veth 인터페이스 생성
- 모든 컨테이너는 외부 통신을 docker0 를 통해 진행.
- 컨테이너는 172.17.x.x 가상 IP 할당 받음.

```sh
# 출력되는 것은 물리/가상 NIC 목록.
ifconfig
# bridge0 확인됨.

# Docker 의 네트워크 목록
docker network ls
```

# 컨테이너 포드 외부 노출
- `port forwarding` 으로 컨테이너 포트를 외부로 노출시켜 외부 연결을 허용할 수 있음.
- `iptables rule` 을 통해 포트 노출

```sh
# host 의 80 포트의 연결을 컨테이너의 8080 포트로 포워딩
docker run -d -p 80:8080 [image\]
```

# 컨테이너 네트워크 추가
- docker0 인터페이스 내에서는 static IP 할당 불가.
    - 사용자 network 에서는 가능

### user defined network 생성
- 아래의 명령어로 사용자의 network 를 생성할 수 있음.
```sh
# 네트워크 생성
docker network create --subnet 192.168.100.0/24 --gateway 192.168.100.254 mynet

# 네트워크 상세
docker inspect network mynet

# 생성한 네트워크로 컨테이너 실행
# --ip 옵션으로 static ip 설정 가능
docker run -d --network mynet -p 80:80 --name web nginx

docker run --name c1 --network mynet -it busybox
$ ip addr
# > 192.168.100.2 확인됨.

# network 확인
docker inspect web

# "Gateway": "192.168.100.1",
# "IPAddress": "192.168.100.2"
```

# 컨테이너 간 통신
- 아래는 wordpress/mySql 예시
- `link` 옵션으로 두 개의 컨테이너가 통신할때 호스트이름 및 환경변수 공유
```sh
# mysql 실행
docker run -d \
  --name mysql \
  -e MYSQL_ROOT_PASSWORD=wordpress \
  -e MYSQL_DATABASE=wordpress \
  -e MYSQL_PASSWORD=wppass \
  -v ~/dbdata:/var/lib/mysql \
  mysql:8.0

# wordpress 실행
docker run -d \
  --name wordpress \
  --link mysql:mysql \
  -e WORDPRESS_DB_HOST=wordpress-db:3306 \
  -e WORDPRESS_DB_PASSWORD=wppass \
  -e WORDPRESS_DB_NAME=wordpress \
  -p 80:80 \
  wordpress:latest
```