# Item 48. 스트림 병렬화는 주의해서 적용하라.
### 자바의 동시성..
- 처음 릴리스부터 스레드, 동기화 wait/notify를 지원
- 자바 5부터 java.util.concurrent 라이브러리와 Executor 프레임워크 지원
- 자바 7부터 고성능 병렬 분해 프레임워크인 fork-join 패키지 추가
- 자바 8부터 parallel 메서드로 파이프라인을 병렬 실행할 수 있는 스트림 지원.

### 동시성 프로그래밍
- 동시성 프로그래밍을 할 떄는, 안전성과 응답 가능 상태를 유지하도록 해야한다.

## parallel 메소드만 사용하면 될까?
- 책의 예시처럼 파이프라인을 병렬화하는 방법을 찾아내지 못하면, 성능 개선을 기대할 수 없다.

### > parallel 로 성능 개선을 기대할 수 없는 경우
(1) 데이터 소스가 STream.iterate인 경우 </br>
(2) 중간 연산으로 limit을 사용한 경우

### > parallel 로 성능 개선 효과가 큰 경우
스트림의 소스가 ArrayList, HashMap, HashSet, ConcurrentHashMap의 인스턴스거나 배열, int/long 범위인 경우

- 위의 자료구조들은 모두 데이터를 원하는 크기로 정확하고 손쉽게 나눌 수 있어서 여러 스레드에 분배하기에 좋음
- 원소들을 순차적으로 실행할 때의 참조 지역성이 뛰어남.
    - 참조 지역성 : 이웃한 원소의 참조들이 메모리에 연속해서 저장됨.
    - 참조 지역성이 낮으면, 스레드는 데이터가 주 메모리에서 캐리 메모리로 전송되어 오기를 기다리는데 시간을 사용함.
    - 참조 지역성은 벌크 연산을 병렬화할 때 중요한 요소다.
    - 참조 지역성이 가장 뛰어난 자료구조는 기본 타입의 배열. 메모리에 연속해서 저장되기 때문.

### 병렬 수행 효율에 영향을 주는 파이프라인의 종단 연산
- 축소가 병렬화에 가장 적합하다.
    - 파이프라인에서 만들어진 모든 원소를 하나로 합침.
- anyMatch, allMatch, noneMatch 처럼 조건에 맞으면 바로 반환되는 메서드도 병렬화에 적합함.
- 가변 축소의 경우에는 컬렉션들을 합치는 부담이 커서 적합하지 않음. (collect 메서드)

> 스트림을 잘못 병렬화하면 성능이 나빠지거나 오동작 할 수 있다. </br>
하지만 조건이 잘 갖춰지면 성능 향상을 얻을 수 있음.

### 무작위 수
- 무작위 수들로 이뤄진 스트림을 병렬화해야한다면 ThreadLocalRandom이나 Random 대신에 SplittableRandom 인스턴스를 사용하자.
- SplittableRandom의 설계 목적이 이 경우이다.
- ThreadLocalRandom은 단일 스레드에서 쓰고자 만들어졌고, Random은 모든 연산을 동기화하기 때문에 병렬 처리하면 성능이 좋지 않음.
